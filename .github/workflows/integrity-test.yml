name: Integrity Test
on:
  pull_request:
    types: ["opened", "synchronize"]
    paths: ["**.rs", "**.toml"]
jobs:
  check-baselayer:
    name: "Integrity Check: Base Layer"
    runs-on: ubuntu-latest
    steps:
      - name: Checking out(HEAD commit)
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Checking out
        uses: actions/checkout@v2
      - name: Building as Checking
        uses: ./.github/actions/checkbuild-baselayer
      - name: Correct package permission for upload-artifact
        if: success()
        run: |
          sudo chmod -R o+r .buildcache/registry/src/github.com-*/unicode-xid-*
          sudo chmod -R o+r .buildcache/target
      - name: Uploading Build Artifacts
        uses: actions/upload-artifact@v1
        if: success()
        with:
          name: "Peridot IntegrityCheck BuildCache"
          path: .buildcache
      - name: Notify as Failure
        uses: ./.github/actions/integrity-check-slack-notifier
        if: failure()
        with:
          status: failure
          failure_step: check-baselayer
          head_sha: ${{ github.event.pull_request.head.sha }}
          base_sha: ${{ github.event.pull_request.base.sha }}
          pr_number: ${{ github.event.number }}
  check-tools:
    name: "Integrity Check: Tools"
    runs-on: ubuntu-latest
    needs: check-baselayer
    steps:
      - name: Checking out(HEAD commit)
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Checking out
        uses: actions/checkout@v2
      - name: Downloading last Build Artifacts
        uses: actions/download-artifact@v1
        with:
          name: "Peridot IntegrityCheck BuildCache"
          path: .buildcache
      - name: Building as Checking
        uses: ./.github/actions/checkbuild-subdir
        with:
          path: tools
      - name: Notify as Failure
        uses: ./.github/actions/integrity-check-slack-notifier
        if: failure()
        with:
          status: failure
          failure_step: check-tools
          head_sha: ${{ github.event.pull_request.head.sha }}
          base_sha: ${{ github.event.pull_request.base.sha }}
          pr_number: ${{ github.event.number }}
  check-modules:
    name: "Integrity Check: Modules"
    runs-on: ubuntu-latest
    needs: check-baselayer
    steps:
      - name: Checking out(HEAD commit)
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Checking out
        uses: actions/checkout@v2
      - name: Downloading last Build Artifacts
        uses: actions/download-artifact@v1
        with:
          name: "Peridot IntegrityCheck BuildCache"
          path: .buildcache
      - name: Building as Checking
        uses: ./.github/actions/checkbuild-subdir
        with:
          path: .
      - name: Uploading Build Artifacts
        uses: actions/upload-artifact@v1
        if: success()
        with:
          name: "Peridot IntegrityCheck BuildCache"
          path: .buildcache
      - name: Notify as Failure
        uses: ./.github/actions/integrity-check-slack-notifier
        if: failure()
        with:
          status: failure
          failure_step: check-modules
          head_sha: ${{ github.event.pull_request.head.sha }}
          base_sha: ${{ github.event.pull_request.base.sha }}
          pr_number: ${{ github.event.number }}
  check-examples:
    name: "Integrity Check: Examples"
    runs-on: ubuntu-latest
    needs: check-modules
    steps:
      - name: Checking out(HEAD commit)
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Checking out
        uses: actions/checkout@v2
      - name: Downloading last Build Artifacts
        uses: actions/download-artifact@v1
        with:
          name: "Peridot IntegrityCheck BuildCache"
          path: .buildcache
      - name: Building as Checking
        uses: ./.github/actions/checkbuild-subdir
        with:
          path: examples
      - name: Notify as Success
        uses: ./.github/actions/integrity-check-slack-notifier
        with:
          status: success
          head_sha: ${{ github.event.pull_request.head.sha }}
          base_sha: ${{ github.event.pull_request.base.sha }}
          pr_number: ${{ github.event.number }}
      - name: Notify as Failure
        uses: ./.github/actions/integrity-check-slack-notifier
        if: failure()
        with:
          status: failure
          failure_step: check-examples
          head_sha: ${{ github.event.pull_request.head.sha }}
          base_sha: ${{ github.event.pull_request.base.sha }}
          pr_number: ${{ github.event.number }}